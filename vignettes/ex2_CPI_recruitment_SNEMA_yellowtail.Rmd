---
title: "WHAM example 2: Cold Pool Index effect on SNEMA Yellowtail Flounder recruitment"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{WHAM example 2: Cold Pool Index effect on SNEMA Yellowtail Flounder recruitment}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
wham.dir <- find.package("wham")
knitr::opts_knit$set(root.dir = file.path(wham.dir,"extdata"))
```
In this vignette we walk through an example using the `wham` (WHAM = the Woods Hole Assessment Model) package to run a state-space age-structured stock assessment model. WHAM is a generalization of code written for [Miller et al. (2016)](https://doi.org/10.1139/cjfas-2015-0339) and [Xu et al. (2018)](https://onlinelibrary.wiley.com/doi/full/10.1111/fog.12236), and in this example we apply WHAM to the same stock, Southern New England / Mid-Atlantic Yellowtail Flounder. 

This is the 2nd `wham` example, which builds off model `m3` from example 1 (full state-space model, numbers at all ages are random effects, multinomial age-compositions). We assume you already have `wham` installed. If not, see the [README](https://github.com/timjmiller/wham#installation-and-basic-use). The simpler 1st example, without environmental effects, is available as a [R script](https://github.com/timjmiller/wham/blob/master/inst/example_scripts/ex1_SNEMA_yellowtail_flounder.R) and [vignette](https://github.com/timjmiller/wham/blob/master/vignettes/ex1_SNEMA_yellowtail_flounder.Rmd).

In example 2, we demonstrate how to specify and run WHAM with varying

- recruitment models (random, Bev-Holt, Ricker)

- environmental covariate (Cold Pool Index, CPI) process models (random walk, AR1), and

- how the CPI affects recruitment (controlling or limiting)

As in [example 1](https://github.com/timjmiller/wham/blob/master/inst/example_scripts/ex1_SNEMA_yellowtail_flounder.R), we check that each model converges (`check_convergence`), plot diagnostics, results, and reference points (`plot_wham_output`), and compare models using AIC and Mohn's rho (`compare_wham_models`).

## 1. Prepare `wham`

Open R and load the `wham` package:

```{r}
library(wham)
library(tidyverse)
```

For a clean, runnable `.R` script, look at `ex2_CPI_recruitment_SNEMA_yellowtail.R` in the `example_scripts` folder of the `wham` package install:
```{r}
wham.dir <- find.package("wham")
file.path(wham.dir, "example_scripts")
```

You can run this entire example script with:
```{r, eval=FALSE}
write.dir <- "choose/where/to/save/output" # otherwise will be saved in working directory
source(file.path(wham.dir, "example_scripts", "ex2_CPI_recruitment_SNEMA_yellowtail.R"))
```

Let's create a directory for this analysis:
```{r, eval=FALSE}
# choose a location to save output
write.dir <- "/path/to/save/output" # modify
dir.create(write.dir)
setwd(write.dir)
```

WHAM was built by modifying the ADMB-based ASAP model code [(Legault and Restrepo 1999)](http://sedarweb.org/docs/wsupp/S12RD06%20ASAPdoc.pdf), and is designed to take an ASAP3 .dat file as input. We generally assume in `wham` that you have an existing ASAP3 .dat file. If you are not familiar with ASAP3 input files, see the [ASAP documentation](https://www.nefsc.noaa.gov/nft/ASAP.html). For this vignette, an example ASAP3 input file is provided, `ASAP_SNEMAYT.dat`.

Copy `ASAP_SNEMAYT.dat` and `CPI.csv` to our analysis directory:
```{r eval=FALSE}
wham.dir <- find.package("wham")
file.copy(from=file.path(wham.dir,"extdata","ASAP_SNEMAYT.dat"), to=write.dir, overwrite=FALSE)
file.copy(from=file.path(wham.dir,"extdata","CPI.csv"), to=write.dir, overwrite=FALSE)
```

Confirm you are in the correct directory and it has the required data files:
```{r}
list.files()
```

Read the ASAP3 .dat file into R and convert to input list for wham:
```{r}
asap3 <- read_asap3_dat("ASAP_SNEMAYT.dat")
```

Load the environmental covariate (Cold Pool Index, CPI) data into R:
```{r}
env.dat <- read.csv("CPI.csv", header=T)
```

We generally abbreviate 'environmental covariate' as `Ecov` in the code. In this example, the `Ecov` data file has columns for observations (`CPI`), standard error (`CPI_sigma`), and year (`Year`). Observations and year are always required. Standard error can be treated as fixed/data with yearly values (as here) or one overall value shared among years. It can also be estimated as a parameter(s), likewise either as yearly values or one overall value.
```{r}
head(env.dat)
```

## 2. Specify models

Now we specify how the 7 models treat recruitment, the CPI process, and how CPI affects recruitment:
```{r}
df.mods <- data.frame(Recruitment = c(2,2,3,3,3,3,4),
                      Ecov_process = c('ar1','ar1','ar1','ar1','rw','ar1','ar1'),
                      Ecov_how = c(0,1,0,2,2,1,1), stringsAsFactors=FALSE)
n.mods <- dim(df.mods)[1]
df.mods$Model <- paste0("m",1:n.mods)
df.mods <- df.mods %>% select(Model, everything()) # moves Model to first col
```

Look at the model table
```{r}
df.mods
```

You specify the options for modeling recruitment and environmental covariate using the `prepare_wham_input` function. WHAM provides 4 options for recruitment (`recruit_model`): 1) random walk, 2) random about mean, 3) Beverton-Holt, and 4) Ricker. 

The environmental covariate options are fed to `prepare_wham_input` as a list, `Ecov`:
```{r eval=FALSE}
  m=1 # example for first model
  Ecov <- list(
    label = "CPI",
    mean = as.matrix(env.dat$CPI),
    sigma = as.matrix(env.dat$CPI_sigma),
    year = env.dat$Year,
    use_obs = matrix(1, ncol=1, nrow=dim(env.dat)[1]), # use all obs (=1)
    process_model = df.mods$Ecov_process[m], # "rw" or "ar1"
    where = "recruit", # CPI affects population via recruitment
    how = df.mods$Ecov_how[m], # 0 = no effect (but still fit Ecov to compare AIC), 1 = controlling (dens-indep mortality), 2 = limiting (carrying capacity), 3 = lethal (threshold), 4 = masking (metabolism/growth), 5 = directive (behavior)
    lag = 1) # CPI in year t affects recruitment in year t+1
```

There are currently 2 options for the `Ecov` process model (`Ecov$process_model`): 1) random walk (`'rw'`), and 2) autoregressive (`'ar1'`). We next must specify **where** the `Ecov` affects the population; here it is via recruitment (`Ecov$where = "recruit"`) as opposed to another process like catchability, mortality, maturity, etc. The options for **how** the `Ecov` affects recruitment (`Ecov$how`) follow [Iles and Beverton (1998)](https://www.sciencedirect.com/science/article/pii/S1385110197000221) and [Xu et al. (2018)](https://onlinelibrary.wiley.com/doi/full/10.1111/fog.12236): 1) "controlling" (dens-indep mortality), 2) "limiting" (carrying capacity, e.g. `Ecov` determines amount of suitable habitat), 3) "lethal" (threshold, i.e. R --> 0 at some `Ecov` value),  4) "masking" (metabolic/growth, `Ecov` decreases dR/dS), and 5) "directive" (e.g. behavioral). Finally, we specify the **lag** at which CPI affects recruitment (`Ecov$lag = 1`, i.e. CPI in year *t* affects recruitment in year *t + 1*).

You can set `Ecov = NULL` to fit the model without environmental covariate data, but note that here we fit the `Ecov` data even for models without an `Ecov` effect on recruitment (`m1` and `m3`) so that we can compare them via AIC (need to have the same data in the likelihood). We accomplish this by setting `Ecov$how = 0`.

Options are described in the `prepare_wham_input` help page. Not all `Ecov$how` options are implemented for every recruitment model.
```{r eval=FALSE}
?prepare_wham_input
```

## 3. Run the models

```{r eval=FALSE}
for(m in 1:n.mods){
  # set up environmental covariate data and model options
  Ecov <- list(
    label = "CPI",
    mean = as.matrix(env.dat$CPI),
    sigma = as.matrix(env.dat$CPI_sigma),
    year = env.dat$Year,
    use_obs = matrix(1, ncol=1, nrow=dim(env.dat)[1]), # use all obs (=1)
    lag = 1, # CPI in year t affects recruitment in year t+1
    process_model = df.mods$Ecov_process[m], # "rw" or "ar1"
    where = "recruit", # CPI affects population via recruitment
    how = df.mods$Ecov_how[m]) # 0 = no effect (but still fit Ecov to compare AIC), 1 = controlling (dens-indep mortality), 2 = limiting (carrying capacity), 3 = lethal (threshold), 4 = masking (metabolism/growth), 5 = directive (behavior)

  # (not used in this vignette) can set Ecov = NULL to fit model without ecov data
  if(is.na(df.mods$Ecov_process[m])) Ecov = NULL 

  # generate wham input from ASAP3 and Ecov data
  input <- prepare_wham_input(asap3, recruit_model = df.mods$Recruitment[m],
                              model_name = "SNEMA Yellowtail Flounder with CPI effects on R",
                              Ecov = Ecov)

  # builds off model m3 from example 1
  # make one or more selectivity blocks with age-specific parameters
  age.specific = 1:3 # 3 age-specific blocks
  not.age.specific = (1:input$data$n_selblocks)[-age.specific]
  input = set_age_sel0(input, age.specific)
  input$par$logit_selpars[not.age.specific,c(1:input$data$n_ages,input$data$n_ages + 3:6)] = Inf
  input$par$logit_selpars[1,5] = Inf
  input$par$logit_selpars[2,4] = Inf
  input$par$logit_selpars[3,2] = Inf

  # Now redefine the map argument for the selectivity parameters to estimate only selectivity parameters without initial values at lower and upper bounds.
  input$map$logit_selpars = matrix(input$map$logit_selpars, input$data$n_selblocks, input$data$n_ages + 6)
  input$map$logit_selpars[is.infinite(input$par$logit_selpars)] = NA
  input$map$logit_selpars[!is.infinite(input$par$logit_selpars)] = 1:sum(!is.infinite(input$par$logit_selpars))
  input$map$logit_selpars = factor(input$map$logit_selpars)

  # full state-space model, abundance is the state vector
  input$data$use_NAA_re = 1
  input$data$random_recruitment = 0
  input$map = input$map[!(names(input$map) %in% c("log_NAA", "log_NAA_sigma", "mean_rec_pars"))]
  input$map$log_R = factor(rep(NA, length(input$par$log_R)))
  input$random = "log_NAA"

  # fit model
  mod <- fit_wham(input, do.retro=TRUE, do.osa=TRUE)

  # output plots (default = HTML with PNG files organized in folders)
  plot_wham_output(mod=mod, dir.main=file.path(getwd(),df.mods$Model[m]), out.type='html')

  # save model
  saveRDS(mod, file=paste0(df.mods$Model[m],".rds"))
}
```

## 4. Check for convergence

Collect all models into a list.
```{r eval=FALSE}
mod.list <- paste0(df.mods$Model,".rds")
mods <- lapply(mod.list, readRDS)
```

There is no indication that any of the models failed to converge. In addition, SE estimates are calculable for all models (invertible Hessian, `TMB::sdrep()` succeeds).
```{r eval=FALSE}
for(m in 1:n.mods) check_convergence(mods[[m]])
```

## 5. Compare models

```{r include=FALSE}
data(vign2_res)
```

Calculate AIC and Mohn's rho using `compare_wham_models`. Note that we can compare models with and without a CPI effect on recruitment using AIC because we also fit the CPI data in the models without the effect.
```{r eval=FALSE}
df.aic <- compare_wham_models(mods, sort=FALSE)$tab
df.mods <- cbind(df.mods, df.aic)
```

Print the results table. `m4` has the lowest AIC (Bev-Holt recruitment, CPI modeled as AR1, *limiting* effect of CPI on recruitment).
```{r eval=FALSE}
# make results table prettier
rownames(df.mods) <- NULL
df.mods$Recruitment <- dplyr::recode(df.mods$Recruitment, `2`='Random', `3`='Bev-Holt', `4`='Ricker')
df.mods$Ecov_how <- dplyr::recode(df.mods$Ecov_how, `0`='---',`1`='Controlling', `2`='Limiting', `4`='Masking')
df.mods <- df.mods[order(df.mods$dAIC),]

df.mods
```

```{r echo=FALSE}
vign2_res
```

Save the results table.
```{r eval=FALSE}
save("df.mods", file="ex2_res.RData")
```

#### Recruitment: random / Bev-Holt / Ricker

Beverton-Holt recruitment was preferred over Ricker and random (`m4` and `m6` lower AIC than `m7` and `m2`).

![Bev-Holt fit from the best fit model, m4](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex2_plots/SSB_Rec_fit_m4.png){ width=60% }

#### CPI effect on recruitment

Models with CPI effects on recruitment (`m2`, `m4-7`) were strongly supported by AIC over models without CPI effects (`m1` and `m3` highest AIC).

There was weak evidence that the Cold Pool *limits* recruitment, as opposed to *controls* recruitment (`m4` vs. `m6`). This aligns with the hypothesis that the CPI indicates the amount of suitable habitat for juvenile yellowtail flounder. In contrast, a controlling effect causes density-independent mortality.

Fitting the CPI with an AR1 model was strongly preferred over a random walk (`m4` vs. `m5`).

## Results

There are 3 options for plotting WHAM output. The default (`out.type='html'`) creates and opens an HTML file with plots organized into tabs (code modified from [`r4ss::SS_html`](https://github.com/r4ss/r4ss/blob/master/R/SS_html.R)):
```{r eval=FALSE}
for(m in 1:n.mods) plot_wham_output(mod=mods[[m]], dir.main=file.path(getwd(), df.mods$Model[m]), out.type='html')
```

#### Stock status

All models estimated a very high (99%) probability of the stock currently experiencing overfishing ($F > F_{40\%}$). All of the models with a stock-recruit function, either Bev-Holt or Ricker, estimated a high (88-98%) probability of the stock not being overfished ($SSB > 0.5 \: SSB_{40\%}$). The base model, `m1`, which modeled recruitment as independent from CPI and SSB, estimated a much higher probability that the stock is overfished (89%).

![Stock status from the best model, m4.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex2_plots/Kobe_status_m4.png){ width=45% }![Stock status from m1.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex2_plots/Kobe_status_m1.png){ width=45% }

Compared to the analogous model without a CPI effect on recruitment (`m3`), the model with CPI (`m4`) estimates relative stock status higher in recent decades and lower in earlier decades.

![Relative stock status trend without CPI, m3.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex2_plots/FSPR_relative_m3.png){ width=45% }![Relative stock status trend with CPI m4.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex2_plots/FSPR_relative_m4.png){ width=45% }

#### Cold Pool Index (CPI)

Note that the `Ecov` is estimated for all model years (plus lag, 1972-2016), even though we only had CPI data for 1973-2011. Extremely poor recruitment in 2014-2015 leads the model to estimate that CPI was high in 2013-2014.

![CPI from best model, m4.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex2_plots/Ecov_1_m4.png){ width=45% }![Recruitment from best model, m4.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex2_plots/SSB_Rec_time_m4.png){ width=45% }

This occurs whether the CPI is modeled as an AR1 or RW process (`m5` shows similar CPI trend). It does not occur in model `m3`, which does not include a relationship between recruitment and the CPI.

![CPI from m5.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex2_plots/Ecov_1_m5.png){ width=45% }![CPI from m3.](https://raw.githubusercontent.com/timjmiller/wham/master/vignettes/ex2_plots/Ecov_1_m3.png){ width=45% }
